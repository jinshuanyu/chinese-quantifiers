<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸­æ–‡é‡è©é…å°å°éŠæˆ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <style>
    :root{ --card-pad:10px; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Inter","Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial;
      background: linear-gradient(135deg,#a7f3d0,#bfdbfe);
      margin:0; height:100svh; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .game-screen{
      background:#fff; width:min(100vw,1000px); height:calc(100svh - 16px);
      border-radius:16px; box-shadow:0 15px 30px rgba(0,0,0,.25);
      position:absolute; inset:0; margin:auto; padding:var(--card-pad);
      display:flex; flex-direction:column; transition:opacity .5s ease;
    }
    /* é¦–é  */
    #title-screen{
      opacity:1; pointer-events:auto;
      background:linear-gradient(135deg,#FFFDE7,#FFF9C4); border:5px solid #FFECB3;
      text-align:center; justify-content:center; align-items:center;
    }
    #title-screen h1{ font-size:clamp(28px,4.5vw,48px); color:#795548; margin:0 0 .8rem 0; }
    #title-screen .start-button{
      padding:1rem 2rem; background:#8BC34A; color:#fff; font-weight:700;
      font-size:clamp(18px,2.5vw,24px); border:none; border-radius:14px; cursor:pointer;
      box-shadow:0 8px 15px rgba(0,0,0,.2); display:inline-flex; align-items:center; gap:.6rem;
    }
    .credits{
      position:absolute; left:0; right:0; bottom:10px;
      text-align:center; font-size:12px; color:#6b7280; pointer-events:none;
    }

    #game-container{ opacity:0; pointer-events:none; }

    /* å·¦å³å…©æ¬„ */
    .two-cols{
      display:grid; grid-template-columns: 1fr .42fr; gap:.6rem;
      flex:1 1 auto; min-height:0;
    }
    #questions-container{
      display:grid; grid-template-rows:repeat(4,1fr); gap:.5rem; min-height:0;
    }
    .q-card{
      background:#e0f2fe; border-radius:14px; box-shadow:0 4px 8px rgba(0,0,0,.08);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:.25rem .4rem; min-height:0;
    }

    /* é¡Œç›®æ›´å¤§ï¼ˆemoji + æ–‡å­—ï¼‰ */
    .q-emoji{
      font-size: clamp(28px, 6vw, 56px);
      line-height: 1;
      margin-bottom: .15rem;
    }
    .q-line{
      display:flex; align-items:center; gap:.5rem;
      font-weight: 800; color:#1f2937;
      font-size: clamp(20px, 4.8vw, 28px); /* ä¸€å®šæ¯”å³æ¬„é¸é …å¤§ */
    }

    /* æŠ•æ”¾æ¡†ï¼šåŠ å¤§ã€å¯è¦–å›é¥‹ã€æ‰‹æ©Ÿå¥½é» */
    .drop-target{
      position:relative;
      width: clamp(46px, 8.2vw, 76px);
      height: clamp(32px, 6.2vw, 48px);
      border:2px dashed #9ca3af; border-radius:10px; background:#fff;
      display:flex; align-items:center; justify-content:center;
      transition: all .12s ease;
      font-size: clamp(18px, 3.6vw, 22px);
      padding:0 .35rem; cursor:pointer;
      touch-action:none; /* æ‰‹æ©Ÿæ‹–æ‹‰ä¿®æ­£ */
    }
    .drop-target.drag-over{
      background:#dbeafe; border-color:#2563eb; border-width:3px;
      box-shadow:0 0 0 3px rgba(37,99,235,.18) inset, 0 0 0 2px rgba(37,99,235,.35);
    }
    .drop-target::after{
      content:""; position:absolute; left:6px; right:6px; bottom:4px; height:0;
      border-bottom:3px solid transparent; transition:border-color .12s ease;
      pointer-events:none;
    }
    .drop-target.drag-over::after{ border-color:#2563eb; }
    .drop-target.ready{ animation:pulseReady 1.2s ease-in-out infinite; }
    @keyframes pulseReady{
      0%{box-shadow:0 0 0 0 rgba(34,197,94,.35)}
      70%{box-shadow:0 0 0 8px rgba(34,197,94,0)}
      100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}
    }

    /* å³æ¬„é¸é …ï¼ˆæ¯”é¡Œç›®ç•¥å°ï¼‰ */
    #quantifiers-pool{ display:grid; grid-template-rows:repeat(5,1fr); gap:.5rem; min-height:0; }
    .quantifier-tile{
      background:#fde68a; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,.08);
      font-weight:900; color:#1f2937;
      font-size: clamp(18px, 3.8vw, 24px);
      display:flex; align-items:center; justify-content:center;
      user-select:none; cursor:grab; height:100%; width:100%;
      transition:transform .12s ease, background .12s ease, outline .12s ease;
      touch-action:none; /* æ‰‹æ©Ÿæ‹–æ‹‰ä¿®æ­£ */
    }
    .quantifier-tile:active{ transform:scale(.96); }
    .quantifier-tile.hide-original{ opacity:0!important; width:0!important; height:0!important; overflow:hidden!important; pointer-events:none; }
    .quantifier-tile.selected{
      outline:3px solid #22c55e; outline-offset:2px; background:#fef08a;
      cursor:pointer;
    }

    /* ä¸­å¤®æç¤ºå¡ï¼ˆå–ä»£ç´°é•·åº•éƒ¨æ¢ï¼‰ */
    #mini-toast{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%, -50%) scale(.98);
      z-index:1000; width:min(92vw,420px);
      background:#111827; color:#fff; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.25);
      padding:16px 18px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px;
      opacity:0; visibility:hidden; transition:opacity .2s ease, visibility .2s ease, transform .2s ease;
    }
    #mini-toast.show{ opacity:1; visibility:visible; transform:translate(-50%, -50%) scale(1); }
    #toast-text{ margin:0; font-size:clamp(18px,4.6vw,22px); line-height:1.4; font-weight:800; }
    #toast-ok{
      width:100%; max-width:260px;
      padding:10px 12px; border:none; border-radius:10px; cursor:pointer;
      background:#60a5fa; color:#fff; font-weight:800; font-size:15px;
    }

    /* å³ä¸‹è§’ ä¸‹ä¸€å›åˆ */
    #next-round-fab{
      position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:1001; padding:10px 14px; border:none; border-radius:12px; cursor:pointer;
      background:#22c55e; color:#fff; font-weight:800; font-size:14px; box-shadow:0 10px 20px rgba(0,0,0,.2);
      display:none;
    }

    .shake{ animation:shake .28s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake{
      0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}
    }
    #game-info{ font-size:clamp(14px,2.7vw,18px); }

    /* æ‰‹æ©Ÿå†æ”¾å¤§ä¸€ç´šï¼ˆâ‰¤640pxï¼‰ */
    @media (max-width:640px){
      .q-emoji{ font-size: clamp(36px, 11vw, 76px); }
      .q-line{  font-size: clamp(22px, 6.6vw, 34px); gap:.6rem; }

      .quantifier-tile{ font-size: clamp(18px, 5vw, 24px); }

      .drop-target{
        width: clamp(64px, 14vw, 104px);
        height: clamp(44px, 10vw, 72px);
        font-size: clamp(20px, 5vw, 24px);
        border-width:3px;
      }

      #toast-text{ font-size: clamp(20px, 6vw, 24px); }
    }
  </style>
</head>
<body>

  <!-- é¦–é  -->
  <div id="title-screen" class="game-screen">
    <h1>é‡è©é…å°</h1>
    <button id="title-start-game-btn" class="start-button">âœ¨ é–‹å§‹éŠæˆ² âœ¨</button>
    <div class="credits">Â© 2025 Christina Yu. All rights reserved.</div>
  </div>

  <!-- éŠæˆ²ä¸»ç•«é¢ -->
  <div id="game-container" class="game-screen">
    <div class="w-full flex items-center justify-between mb-2" id="game-info">
      <div class="font-bold text-gray-700">å›åˆï¼š<span id="current-round">0</span> / 12</div>
      <div class="font-bold text-gray-700">åˆ†æ•¸ï¼š<span id="score">0</span></div>
    </div>

    <div class="two-cols">
      <div id="questions-container"></div>
      <div id="quantifiers-pool"></div>
    </div>

    <button id="next-round-fab">ä¸‹ä¸€å›åˆ âœ</button>
  </div>

  <!-- ä¸­å¤®æç¤ºå¡ -->
  <div id="mini-toast" role="dialog" aria-live="polite" aria-modal="true">
    <p id="toast-text">éé—œï¼å¤ªæ£’äº†ï¼</p>
    <button id="toast-ok">ç¢ºå®š</button>
  </div>

  <script>
    window.onload = function () {
      /* ====== é¡Œåº«ï¼ˆ12 å›åˆ Ã— 4 é¡Œï¼‰====== */
      const gameData = [
        // 1
        [
          { emoji:"ğŸ¬", prefix:"ä¸€", noun:"ç³–æœ", quantifier:"é¡†" },
          { emoji:"ğŸ§‹", prefix:"ä¸€", noun:"çå¥¶",   quantifier:"æ¯" },
          { emoji:"ğŸŒ", prefix:"ä¸€", noun:"é¦™è•‰",   quantifier:"æ ¹" },
          { emoji:"ğŸª™", prefix:"ä¸€", noun:"ç¡¬å¹£",   quantifier:"æš" },
        ],
        // 2
        [
          { emoji:"ğŸ®", prefix:"ä¸€", noun:"ç‰›",   quantifier:"é ­" },
          { emoji:"ğŸŸ", prefix:"ä¸€", noun:"é­š",   quantifier:"æ¢" },
          { emoji:"ğŸˆ", prefix:"ä¸€", noun:"è²“",   quantifier:"éš»" },
          { emoji:"ğŸ", prefix:"ä¸€", noun:"é¦¬",   quantifier:"åŒ¹" },
        ],
        // 3
        [
          { emoji:"ğŸ“–", prefix:"ä¸€", noun:"æ›¸",   quantifier:"æœ¬" },
          { emoji:"ğŸ‘©â€ğŸ«", prefix:"ä¸€", noun:"è€å¸«", quantifier:"ä½" },
          { emoji:"ğŸ«", prefix:"ä¸€", noun:"å­¸æ ¡", quantifier:"æ‰€" },
          { emoji:"ğŸ””", prefix:"ä¸€", noun:"é˜",   quantifier:"å£" },
        ],
        // 4
        [
          { emoji:"ğŸš—", prefix:"ä¸€", noun:"æ±½è»Š", quantifier:"è¼›" },
          { emoji:"ğŸš‚", prefix:"ä¸€", noun:"ç«è»Š", quantifier:"åˆ—" },
          { emoji:"ğŸ’º", prefix:"ä¸€", noun:"åº§ä½", quantifier:"å€‹" },
          { emoji:"ğŸ«", prefix:"ä¸€", noun:"ç¥¨",   quantifier:"å¼µ" },
        ],
        // 5
        [
          { emoji:"ğŸ§±", prefix:"ä¸€", noun:"ç‰†",   quantifier:"å µ" },
          { emoji:"ğŸšª", prefix:"ä¸€", noun:"é–€",   quantifier:"æ‰‡" },
          { emoji:"ğŸª‘", prefix:"ä¸€", noun:"æ¤…å­", quantifier:"å¼µ" },
          { emoji:"ğŸª", prefix:"ä¸€", noun:"åº—",   quantifier:"å®¶" },
        ],
        // 6
        [
          { emoji:"ğŸŒ¾", prefix:"ä¸€", noun:"ç±³",   quantifier:"ç²’" },
          { emoji:"ğŸš", prefix:"ä¸€", noun:"é£¯",   quantifier:"ç¢—" },
          { emoji:"ğŸ¥˜", prefix:"ä¸€", noun:"èœ",   quantifier:"é“" },
          { emoji:"ğŸ´", prefix:"ä¸€", noun:"åˆ€å‰", quantifier:"å‰¯" },
        ],
        // 7
        [
          { emoji:"ğŸ¥¢", prefix:"ä¸€", noun:"ç­·å­", quantifier:"é›™" },
          { emoji:"ğŸ’¡", prefix:"ä¸€", noun:"ç‡ˆ",   quantifier:"ç›" },
          { emoji:"ğŸ”‘", prefix:"ä¸€", noun:"é‘°åŒ™", quantifier:"æŠŠ" },
          { emoji:"ğŸ›", prefix:"ä¸€", noun:"æ£‰è¢«", quantifier:"åºŠ" },
        ],
        // 8
        [
          { emoji:"âœ‰ï¸", prefix:"ä¸€", noun:"ä¿¡",   quantifier:"å°" },
          { emoji:"ğŸ“œ", prefix:"ä¸€", noun:"æ–‡ç« ", quantifier:"ç¯‡" },
          { emoji:"ğŸ“°", prefix:"ä¸€", noun:"æ–°è", quantifier:"å‰‡" },
          { emoji:"ğŸ¶", prefix:"ä¸€", noun:"æ­Œ",   quantifier:"é¦–" },
        ],
        // 9
        [
          { emoji:"â˜ï¸", prefix:"ä¸€", noun:"é›²",   quantifier:"æœµ" },
          { emoji:"ğŸŒˆ", prefix:"ä¸€", noun:"å½©è™¹", quantifier:"é“" },
          { emoji:"ğŸŒŸ", prefix:"ä¸€", noun:"æ˜Ÿ",   quantifier:"é¡†" },
          { emoji:"ğŸŒ•", prefix:"ä¸€", noun:"æ˜æœˆ", quantifier:"è¼ª" },
        ],
        // 10
        [
          { emoji:"ğŸ™‚", prefix:"ä¸€", noun:"è‡‰",   quantifier:"å¼µ" },
          { emoji:"ğŸ˜¢", prefix:"ä¸€", noun:"çœ¼æ·š", quantifier:"æ»´" },
          { emoji:"ğŸ’¬", prefix:"ä¸€", noun:"è©±",   quantifier:"å¥" },
          { emoji:"â™¥ï¸", prefix:"ä¸€", noun:"å¿ƒ",   quantifier:"é¡†" },
        ],
        // 11
        [
          { emoji:"ğŸ›©", prefix:"ä¸€", noun:"é£›æ©Ÿ", quantifier:"æ¶" },
          { emoji:"ğŸ›¶", prefix:"ä¸€", noun:"èˆ¹",   quantifier:"è‰˜" },
          { emoji:"ğŸƒ", prefix:"ä¸€", noun:"æ‰èˆŸ", quantifier:"è‘‰" },
          { emoji:"ğŸŒ¬", prefix:"ä¸€", noun:"è¼•ç…™", quantifier:"ç¸·" },
        ],
        // 12
        [
          { emoji:"ğŸ–¼", prefix:"ä¸€", noun:"ç•«",   quantifier:"å¹…" },
          { emoji:"ğŸ“", prefix:"ä¸€", noun:"è©©",   quantifier:"é¦–" },
          { emoji:"ğŸ­", prefix:"ä¸€", noun:"æˆ²",   quantifier:"é½£" },
          { emoji:"ğŸ˜­", prefix:"å…©", noun:"ç†±æ·š", quantifier:"è¡Œ" },
        ],
      ];

      let currentRound = 0;
      let score = 0;
      let answeredThisRound = 0;

      let activeDraggedDesktopElement = null;
      // è§¸æ§æ‹–æ›³
      let currentTouchDraggedElement = null, touchVisualClone = null, currentTouchOffsetX = 0, currentTouchOffsetY = 0;
      // é»æŒ‰å‚™æ´
      let selectedTile = null;

      const currentRoundSpan = document.getElementById("current-round");
      const scoreSpan = document.getElementById("score");
      const questionsContainer = document.getElementById("questions-container");
      const quantifiersPool = document.getElementById("quantifiers-pool");

      const gameContainer = document.getElementById("game-container");
      const titleScreen = document.getElementById("title-screen");
      const titleStartGameBtn = document.getElementById("title-start-game-btn");

      // Toast & ä¸‹ä¸€å›åˆ
      const miniToast = document.getElementById("mini-toast");
      const toastText = document.getElementById("toast-text");
      const toastOk = document.getElementById("toast-ok");
      const nextFab = document.getElementById("next-round-fab");

      // éŸ³æ•ˆ
      const correctSynth = new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:0.005,decay:0.1,sustain:0.1,release:0.1}}).toDestination();
      const incorrectSynth = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.01,decay:0.2,sustain:0.05,release:0.1}}).toDestination();
      const gameStartSynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.05,decay:0.3,sustain:0.2,release:0.5}}).toDestination();
      const celebrateSynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.2,sustain:0.2,release:0.6}}).toDestination();

      function playCelebration(){
        // å°å’Œå¼¦ + é€£çºŒå››éŸ³ï¼Œç°¡å–®çš„æ…¶ç¥éŸ³æ•ˆ
        try{
          correctSynth.triggerAttackRelease(["C5","E5","G5","C6"],"8n");
          const seq = ["E5","G5","C6","E6"];
          seq.forEach((n,i)=> setTimeout(()=> celebrateSynth.triggerAttackRelease(n,"8n"), 150 + i*170));
        }catch(e){}
      }

      function showToast(message, onConfirm){
        toastText.innerHTML = message;
        miniToast.classList.add('show');
        const handler = () => {
          miniToast.classList.remove('show');
          toastOk.removeEventListener('click', handler);
          if (onConfirm) onConfirm();
        };
        toastOk.addEventListener('click', handler);
      }
      function showNextFab(isFinal=false){
        nextFab.textContent = isFinal ? "å›é¦–é  â­®" : "ä¸‹ä¸€å›åˆ âœ";
        nextFab.style.display = "inline-block";
        nextFab.onclick = () => {
          nextFab.style.display = "none";
          if(isFinal){
            gameContainer.style.opacity='0'; gameContainer.style.pointerEvents='none';
            setTimeout(()=>{ titleScreen.style.opacity='1'; titleScreen.style.pointerEvents='auto'; initialize(); }, 300);
          }else{
            loadRound();
          }
        };
      }
      function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

      function deselectTile(){
        if(selectedTile){
          selectedTile.classList.remove('selected');
          selectedTile = null;
          document.querySelectorAll('.drop-target').forEach(t=>t.classList.remove('ready'));
        }
      }
      function selectTile(tile){
        if(selectedTile===tile){ deselectTile(); return; }
        if(selectedTile){ deselectTile(); }
        selectedTile = tile;
        tile.classList.add('selected');
        document.querySelectorAll('.drop-target').forEach(t=>t.classList.add('ready'));
      }

      function handleQuantifierDrop(dropTarget, droppedQuantifier, originEl=null){
        if(dropTarget.textContent && dropTarget.textContent.trim().length>0) return;

        const correct = dropTarget.dataset.correctQuantifier;
        if(droppedQuantifier===correct){
          dropTarget.textContent = droppedQuantifier;
          dropTarget.style.borderStyle="solid";
          dropTarget.style.borderColor="#16a34a";
          dropTarget.style.background="#bbf7d0";
          dropTarget.style.color="#065f46";

          if(originEl){ originEl.remove(); }
          else{
            const toRemove = document.querySelector(`.quantifier-tile[data-quantifier="${droppedQuantifier}"]`);
            if(toRemove) toRemove.remove();
          }
          deselectTile();

          score += 10; scoreSpan.textContent = score;

          dropTarget.removeEventListener('drop', handleDrop);
          dropTarget.removeEventListener('dragover', handleDragOver);
          dropTarget.removeEventListener('dragleave', handleDragLeave);

          correctSynth.triggerAttackRelease(["C5","E5","G5"],"8n");

          answeredThisRound++;
          if(answeredThisRound===4){
            if(currentRound===12){
              // å…¨ç ´ï¼šæ…¶ç¥éŸ³æ•ˆ + æŒ‡å®šè¨Šæ¯
              playCelebration();
              showToast("ğŸ‰ æ­å–œä½ å…¨éƒ¨éé—œï¼", () => showNextFab(true));
            }else{
              showToast("æœ¬å›åˆå®Œæˆï¼", () => showNextFab(false));
            }
          }
        }else{
          if(originEl){
            originEl.classList.remove('hide-original');
            originEl.classList.add('shake');
            originEl.addEventListener('animationend',()=>originEl.classList.remove('shake'),{once:true});
          }
          incorrectSynth.triggerAttackRelease("C3","16n");
        }
      }

      /* æ¡Œæ©Ÿæ‹–æ›³ */
      function handleDragStart(e){
        activeDraggedDesktopElement = e.target;
        e.dataTransfer.setData('text/plain', e.target.dataset.quantifier);
        e.dataTransfer.effectAllowed = "move";
      }
      function handleDragEnd(){ activeDraggedDesktopElement=null; }
      function handleDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect="move"; e.target.classList.add('drag-over'); }
      function handleDragLeave(e){ e.target.classList.remove('drag-over'); }
      function handleDrop(e){
        e.preventDefault(); e.target.classList.remove('drag-over');
        const q = e.dataTransfer.getData('text/plain');
        handleQuantifierDrop(e.target, q, activeDraggedDesktopElement);
      }

      /* æ‰‹æ©Ÿæ‹–æ›³ */
      function handleTouchStart(e){
        e.preventDefault();
        const touch = e.touches[0];
        currentTouchDraggedElement = e.target;
        currentTouchDraggedElement.classList.add('hide-original');

        touchVisualClone = document.createElement('div');
        touchVisualClone.textContent = currentTouchDraggedElement.textContent;
        touchVisualClone.className = 'quantifier-tile';
        touchVisualClone.style.position='fixed';
        touchVisualClone.style.zIndex='9999';
        touchVisualClone.style.pointerEvents='none';
        touchVisualClone.style.width='64px'; touchVisualClone.style.height='40px';
        touchVisualClone.style.display='flex'; touchVisualClone.style.alignItems='center'; touchVisualClone.style.justifyContent='center';
        touchVisualClone.style.background='#fcd34d'; touchVisualClone.style.border='2px solid #3b82f6';
        touchVisualClone.style.borderRadius='10px'; touchVisualClone.style.boxShadow='0 10px 20px rgba(0,0,0,.2)';
        document.body.appendChild(touchVisualClone);

        const rect = currentTouchDraggedElement.getBoundingClientRect();
        currentTouchOffsetX = touch.clientX - rect.left;
        currentTouchOffsetY = touch.clientY - rect.top;

        touchVisualClone.style.left = (touch.clientX - currentTouchOffsetX) + 'px';
        touchVisualClone.style.top  = (touch.clientY - currentTouchOffsetY) + 'px';
      }
      function handleTouchMove(e){
        e.preventDefault();
        if(!touchVisualClone) return;
        const t = e.touches[0];
        touchVisualClone.style.left = (t.clientX - currentTouchOffsetX) + 'px';
        touchVisualClone.style.top  = (t.clientY - currentTouchOffsetY) + 'px';

        document.querySelectorAll('.drop-target').forEach(target=>{
          const r = target.getBoundingClientRect();
          if(t.clientX>r.left && t.clientX<r.right && t.clientY>r.top && t.clientY<r.bottom) target.classList.add('drag-over');
          else target.classList.remove('drag-over');
        });
      }
      function handleTouchEnd(e){
        e.preventDefault();
        if(!touchVisualClone) return;
        const t = e.changedTouches[0];
        let dropped=false;
        document.querySelectorAll('.drop-target').forEach(target=>{
          target.classList.remove('drag-over');
          const r = target.getBoundingClientRect();
          if(!dropped && t.clientX>r.left && t.clientX<r.right && t.clientY>r.top && t.clientY<r.bottom){
            handleQuantifierDrop(target, currentTouchDraggedElement.dataset.quantifier, currentTouchDraggedElement);
            dropped=true;
          }
        });
        if(touchVisualClone && touchVisualClone.parentNode) touchVisualClone.parentNode.removeChild(touchVisualClone);
        touchVisualClone=null;
        if(!dropped && currentTouchDraggedElement){
          currentTouchDraggedElement.classList.remove('hide-original');
        }
        currentTouchDraggedElement=null;
      }

      function initialize(){
        currentRound=0; score=0; answeredThisRound=0;
        currentRoundSpan.textContent=currentRound; scoreSpan.textContent=score;
        questionsContainer.innerHTML=""; quantifiersPool.innerHTML="";
        nextFab.style.display="none";
        deselectTile();
      }

      async function startGame(){
        try{ await Tone.start(); }catch(e){}
        titleScreen.style.opacity='0';
        titleScreen.style.pointerEvents='none';
        setTimeout(()=>{
          gameContainer.style.opacity='1';
          gameContainer.style.pointerEvents='auto';
        }, 300);
        try{ gameStartSynth.triggerAttackRelease("C5","8n"); }catch(e){}
        initialize();
        loadRound();
      }

      function addTapHandlers(){
        // å³æ¬„ï¼šé»ä¸€ä¸‹é¸æ“‡
        document.querySelectorAll('.quantifier-tile').forEach(tile=>{
          tile.addEventListener('click', ()=> selectTile(tile));
        });
        // å·¦æ¬„ï¼šé»ä¸€ä¸‹æŠ•æ”¾
        document.querySelectorAll('.drop-target').forEach(target=>{
          target.addEventListener('click', ()=> {
            if(!selectedTile) return;
            handleQuantifierDrop(target, selectedTile.dataset.quantifier, selectedTile);
          });
        });
      }

      function loadRound(){
        currentRound++;
        currentRoundSpan.textContent=currentRound;
        answeredThisRound=0;
        questionsContainer.innerHTML=""; quantifiersPool.innerHTML="";
        nextFab.style.display="none";
        deselectTile();

        if(currentRound>gameData.length){
          playCelebration();
          showToast("ğŸ‰ æ­å–œä½ å…¨éƒ¨éé—œï¼", ()=> showNextFab(true));
          return;
        }

        const currentQuestions = [...gameData[currentRound-1]];

        // å·¦æ¬„ 4 é¡Œ
        currentQuestions.forEach((q)=>{
          const card = document.createElement('div');
          card.className = 'q-card';
          card.innerHTML = `
            <div class="q-emoji">${q.emoji}</div>
            <div class="q-line">
              <span>${q.prefix}</span>
              <span class="drop-target" data-correct-quantifier="${q.quantifier}"></span>
              <span>${q.noun}</span>
            </div>
          `;
          questionsContainer.appendChild(card);
          const target = card.querySelector('.drop-target');
          target.addEventListener('dragover', handleDragOver);
          target.addEventListener('dragleave', handleDragLeave);
          target.addEventListener('drop', handleDrop);
        });

        // å³æ¬„ï¼š4 æ­£ç¢º + 1 å¹²æ“¾
        const correctQ = currentQuestions.map(q=>q.quantifier);
        const allQ = gameData.flat().map(q=>q.quantifier);
        let distracter = null;
        while(true){
          const r = allQ[Math.floor(Math.random()*allQ.length)];
          if(!correctQ.includes(r)){ distracter = r; break; }
        }
        const options = shuffleArray([...correctQ, distracter]);

        options.forEach(qf=>{
          const tile = document.createElement('div');
          tile.className = 'quantifier-tile';
          tile.textContent = qf;
          tile.setAttribute('draggable','true');
          tile.dataset.quantifier = qf;
          quantifiersPool.appendChild(tile);

          tile.addEventListener('dragstart', handleDragStart);
          tile.addEventListener('dragend', handleDragEnd);
          tile.addEventListener('touchstart', handleTouchStart, {passive:false});
          tile.addEventListener('touchmove',  handleTouchMove,  {passive:false});
          tile.addEventListener('touchend',   handleTouchEnd,   {passive:false});
        });

        // é»æŒ‰å‚™æ´å•Ÿç”¨
        addTapHandlers();
      }

      titleStartGameBtn.addEventListener('click', startGame);
      initialize();
    };
  </script>
</body>
</html>

