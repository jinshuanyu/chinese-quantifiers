<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>中文量詞配對小遊戲</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
<style>
    :root{ --card-pad:10px; }
body{
  font-family: "Iansui", "Noto Sans TC", "PingFang TC", "Microsoft JhengHei",
               ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: linear-gradient(135deg,#a7f3d0,#bfdbfe);
  margin:0; height:100svh; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
}

    .game-screen{
      background:#fff; width:min(100vw,1000px); height:calc(100svh - 16px);
      border-radius:16px; box-shadow:0 15px 30px rgba(0,0,0,.25);
      position:absolute; inset:0; margin:auto; padding:var(--card-pad);
      display:flex; flex-direction:column; transition:opacity .5s ease;
    }
    /* 首頁 */
    #title-screen{
      opacity:1; pointer-events:auto;
      background:linear-gradient(135deg,#FFFDE7,#FFF9C4); border:5px solid #FFECB3;
      text-align:center; justify-content:center; align-items:center;
    }
    #title-screen h1{ font-size:clamp(28px,4.5vw,48px); color:#795548; margin:0 0 .8rem 0; }
    #title-screen .start-button{
      padding:1rem 2rem; background:#8BC34A; color:#fff; font-weight:700;
      font-size:clamp(18px,2.5vw,24px); border:none; border-radius:14px; cursor:pointer;
      box-shadow:0 8px 15px rgba(0,0,0,.2); display:inline-flex; align-items:center; gap:.6rem;
    }
    .credits{
      position:absolute; left:0; right:0; bottom:10px;
      text-align:center; font-size:12px; color:#6b7280; 
    }

    #game-container{ opacity:0; pointer-events:none; }

    /* 左右兩欄 */
    .two-cols{
      display:grid; grid-template-columns: 1fr .42fr; gap:.6rem;
      flex:1 1 auto; min-height:0;
    }
    #questions-container{
      display:grid; grid-template-rows:repeat(4,1fr); gap:.5rem; min-height:0;
    }
    .q-card{
      background:#e0f2fe; border-radius:14px; box-shadow:0 4px 8px rgba(0,0,0,.08);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:.25rem .4rem; min-height:0;
      touch-action:none; /* 讓整張卡片也能安全接觸控拖曳 */
    }

    /* 題目更大（emoji + 文字） */
    .q-emoji{ font-size: clamp(28px, 6vw, 56px); line-height:1; margin-bottom:.15rem; }
    .q-line{
      display:flex; align-items:center; gap:.5rem;
      font-weight:800; color:#1f2937;
      font-size: clamp(20px, 4.8vw, 28px); /* 比右欄選項大 */
    }

    /* 投放框：可視回饋 */
    .drop-target{
      position:relative;
      width: clamp(46px, 8.2vw, 76px);
      height: clamp(32px, 6.2vw, 48px);
      border:2px dashed #9ca3af; border-radius:10px; background:#fff;
      display:flex; align-items:center; justify-content:center;
      transition: all .12s ease;
      font-size: clamp(18px, 3.6vw, 22px);
      padding:0 .35rem; cursor:pointer; touch-action:none;
    }
    .drop-target.drag-over{
      background:#dbeafe; border-color:#2563eb; border-width:3px;
      box-shadow:0 0 0 3px rgba(37,99,235,.18) inset, 0 0 0 2px rgba(37,99,235,.35);
    }
    .drop-target::after{
      content:""; position:absolute; left:6px; right:6px; bottom:4px; height:0;
      border-bottom:3px solid transparent; transition:border-color .12s ease;
      pointer-events:none;
    }
    .drop-target.drag-over::after{ border-color:#2563eb; }
    .drop-target.ready{ animation:pulseReady 1.2s ease-in-out infinite; }
    @keyframes pulseReady{
      0%{box-shadow:0 0 0 0 rgba(34,197,94,.35)}
      70%{box-shadow:0 0 0 8px rgba(34,197,94,0)}
      100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}
    }

    /* 右欄選項（比題目略小） */
    #quantifiers-pool{ display:grid; grid-template-rows:repeat(5,1fr); gap:.5rem; min-height:0; }
    .quantifier-tile{
      background:#fde68a; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,.08);
      font-weight:900; color:#1f2937;
      font-size: clamp(18px, 3.8vw, 24px);
      display:flex; align-items:center; justify-content:center;
      user-select:none; cursor:grab; height:100%; width:100%;
      transition:transform .12s ease, background .12s ease, outline .12s ease;
      touch-action:none;
    }
    .quantifier-tile:active{ transform:scale(.96); }
    .quantifier-tile.hide-original{ opacity:0!important; width:0!important; height:0!important; overflow:hidden!important; pointer-events:none; }
    .quantifier-tile.selected{ outline:3px solid #22c55e; outline-offset:2px; background:#fef08a; cursor:pointer; }

    /* 中央提示卡 */
    #mini-toast{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%, -50%) scale(.98);
      z-index:1000; width:min(92vw,420px);
      background:#111827; color:#fff; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.25);
      padding:16px 18px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px;
      opacity:0; visibility:hidden; transition:opacity .2s ease, visibility .2s ease, transform .2s ease;
    }
    #mini-toast.show{ opacity:1; visibility:visible; transform:translate(-50%, -50%) scale(1); }
    #toast-text{ margin:0; font-size:clamp(18px,4.6vw,22px); line-height:1.4; font-weight:800; }
    #toast-ok{
      width:100%; max-width:260px; padding:10px 12px; border:none; border-radius:10px; cursor:pointer;
      background:#60a5fa; color:#fff; font-weight:800; font-size:15px;
    }

    /* 右下角 下一回合 */
    #next-round-fab{
      position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:1001; padding:10px 14px; border:none; border-radius:12px; cursor:pointer;
      background:#22c55e; color:#fff; font-weight:800; font-size:14px; box-shadow:0 10px 20px rgba(0,0,0,.2);
      display:none;
    }

    .shake{ animation:shake .28s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake{
      0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}
    }
    #game-info{ font-size:clamp(14px,2.7vw,18px); }

    /* 手機再放大一級（≤640px） */
    @media (max-width:640px){
      .q-emoji{ font-size: clamp(36px, 11vw, 76px); }
      .q-line{  font-size: clamp(22px, 6.6vw, 34px); gap:.6rem; }
      .quantifier-tile{ font-size: clamp(18px, 5vw, 24px); }
      .drop-target{
        width: clamp(64px, 14vw, 104px);
        height: clamp(44px, 10vw, 72px);
        font-size: clamp(20px, 5vw, 24px);
        border-width:3px;
      }
      #toast-text{ font-size: clamp(20px, 6vw, 24px); }
    }
  </style>
</head>
<body>
<!-- 首頁 -->
<div id="title-screen" class="game-screen">
  <h1>量詞配對</h1>

  <!-- 主按鈕：開始遊戲 -->
  <button id="title-start-game-btn" class="start-button">✨ 開始遊戲 ✨</button>

  <!-- 次要按鈕：遊戲說明 -->
  <a
    href="https://www.mamahowma.com/2025/09/chinese-quantifiers.html"
    target="_blank"
    class="mt-4 inline-block bg-green-200 text-green-900 font-semibold px-4 py-2 rounded-lg text-lg hover:bg-green-300 transition"
  >
    ℹ️ 遊戲說明
  </a>

<!-- Footer 聯絡資訊 -->
<div class="credits text-sm text-gray-600 leading-snug">
  © 2025 Christina Yu. All rights reserved. <br />
  <a href="mailto:mamahowma@gmail.com" class="underline text-blue-700">
    <i class="fa-solid fa-envelope text-xl"></i></a>　<a href="https://www.facebook.com/mamahowma" target="_blank" class="text-blue-600">
    <i class="fa-brands fa-facebook text-xl"></i>
  </a>　<a href="https://portaly.cc/mamahowma/support" target="_blank" class="text-yellow-700">
    <i class="fa-solid fa-mug-hot text-xl"></i>
  </a> 
</div>

</div>


  <!-- 遊戲主畫面 -->
  <div id="game-container" class="game-screen">
    <!-- 回合 / 時間 / 分數 -->
    <div class="w-full flex items-center mb-2" id="game-info">
      <div class="basis-1/3 font-bold text-gray-700">回合：<span id="current-round">0</span> / 12</div>
      <div class="basis-1/3 text-center font-bold text-gray-700">時間：<span id="timer">00:00</span></div>
      <div class="basis-1/3 text-right font-bold text-gray-700">分數：<span id="score">0</span></div>
    </div>

    <div class="two-cols">
      <div id="questions-container"></div>
      <div id="quantifiers-pool"></div>
    </div>

    <button id="next-round-fab">下一回合 ➜</button>
  </div>

  <!-- 中央提示卡 -->
  <div id="mini-toast" role="dialog" aria-live="polite" aria-modal="true">
    <p id="toast-text">過關！太棒了！</p>
    <button id="toast-ok">確定</button>
  </div>

  <script>
    window.onload = function () {
      /* ===== 題庫（12 回合 × 4 題） ===== */
      const gameData = [
        [
          { emoji:"🍬", prefix:"一", noun:"糖果", quantifier:"顆" },
          { emoji:"🧋", prefix:"一", noun:"珍奶", quantifier:"杯" },
          { emoji:"🍌", prefix:"一", noun:"香蕉", quantifier:"根" },
          { emoji:"🪙", prefix:"一", noun:"硬幣", quantifier:"枚" },
        ],
        [
          { emoji:"🐮", prefix:"一", noun:"牛", quantifier:"頭" },
          { emoji:"🐟", prefix:"一", noun:"魚", quantifier:"條" },
          { emoji:"🐈", prefix:"一", noun:"貓", quantifier:"隻" },
          { emoji:"🐎", prefix:"一", noun:"馬", quantifier:"匹" },
        ],
        [
          { emoji:"📖", prefix:"一", noun:"書", quantifier:"本" },
          { emoji:"👩‍🏫", prefix:"一", noun:"老師", quantifier:"位" },
          { emoji:"🏫", prefix:"一", noun:"學校", quantifier:"所" },
          { emoji:"🔔", prefix:"一", noun:"鐘", quantifier:"口" },
        ],
        [
          { emoji:"🚗", prefix:"一", noun:"汽車", quantifier:"輛" },
          { emoji:"🚂", prefix:"一", noun:"火車", quantifier:"列" },
          { emoji:"💺", prefix:"一", noun:"座位", quantifier:"個" },
          { emoji:"🎫", prefix:"一", noun:"票", quantifier:"張" },
        ],
        [
          { emoji:"🧱", prefix:"一", noun:"牆", quantifier:"堵" },
          { emoji:"🚪", prefix:"一", noun:"門", quantifier:"扇" },
          { emoji:"🪑", prefix:"一", noun:"椅子", quantifier:"張" },
          { emoji:"🏪", prefix:"一", noun:"店", quantifier:"家" },
        ],
        [
          { emoji:"🌾", prefix:"一", noun:"米", quantifier:"粒" },
          { emoji:"🍚", prefix:"一", noun:"飯", quantifier:"碗" },
          { emoji:"🥘", prefix:"一", noun:"菜", quantifier:"道" },
          { emoji:"🍴", prefix:"一", noun:"刀叉", quantifier:"副" },
        ],
        [
          { emoji:"🥢", prefix:"一", noun:"筷子", quantifier:"雙" },
          { emoji:"💡", prefix:"一", noun:"燈", quantifier:"盞" },
          { emoji:"🔑", prefix:"一", noun:"鑰匙", quantifier:"把" },
          { emoji:"🛏", prefix:"一", noun:"棉被", quantifier:"床" },
        ],
        [
          { emoji:"✉️", prefix:"一", noun:"信", quantifier:"封" },
          { emoji:"📜", prefix:"一", noun:"文章", quantifier:"篇" },
          { emoji:"📰", prefix:"一", noun:"新聞", quantifier:"則" },
          { emoji:"🎶", prefix:"一", noun:"歌", quantifier:"首" },
        ],
        [
          { emoji:"☁️", prefix:"一", noun:"雲", quantifier:"朵" },
          { emoji:"🌈", prefix:"一", noun:"彩虹", quantifier:"道" },
          { emoji:"🌟", prefix:"一", noun:"星", quantifier:"顆" },
          { emoji:"🌕", prefix:"一", noun:"明月", quantifier:"輪" },
        ],
        [
          { emoji:"🙂", prefix:"一", noun:"臉", quantifier:"張" },
          { emoji:"😢", prefix:"一", noun:"眼淚", quantifier:"滴" },
          { emoji:"💬", prefix:"一", noun:"話", quantifier:"句" },
          { emoji:"♥️", prefix:"一", noun:"心", quantifier:"顆" },
        ],
        [
          { emoji:"🛩", prefix:"一", noun:"飛機", quantifier:"架" },
          { emoji:"🛶", prefix:"一", noun:"船", quantifier:"艘" },
          { emoji:"🍃", prefix:"一", noun:"扁舟", quantifier:"葉" },
          { emoji:"🌬", prefix:"一", noun:"輕煙", quantifier:"縷" },
        ],
        [
          { emoji:"🖼", prefix:"一", noun:"畫", quantifier:"幅" },
          { emoji:"📝", prefix:"一", noun:"詩", quantifier:"首" },
          { emoji:"🎭", prefix:"一", noun:"戲", quantifier:"齣" },
          { emoji:"😭", prefix:"兩", noun:"熱淚", quantifier:"行" },
        ],
      ];

      let currentRound = 0;
      let score = 0;
      let answeredThisRound = 0;

      /* 計時 */
      let startTime = null, timerInterval = null;
      const timerSpan = document.getElementById("timer");
      function pad2(n){ return n.toString().padStart(2,'0'); }
      function formatShort(ms){
        const t=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(t/3600);
        const m=Math.floor((t%3600)/60); const s=t%60;
        return h>0?`${pad2(h)}:${pad2(m)}:${pad2(s)}`:`${pad2(m)}:${pad2(s)}`;
      }
      function formatLong(ms){
        const t=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(t/3600);
        const m=Math.floor((t%3600)/60); const s=t%60;
        if(h>0) return `${h} 小時 ${m} 分 ${s} 秒`;
        if(m>0) return `${m} 分 ${s} 秒`;
        return `${s} 秒`;
      }
      function startTimer(){ startTime=Date.now(); updateTimer(); timerInterval=setInterval(updateTimer,500); }
      function stopTimer(){ if(timerInterval){clearInterval(timerInterval); timerInterval=null;} }
      function getElapsedMs(){ return startTime ? (Date.now()-startTime) : 0; }
      function updateTimer(){ timerSpan.textContent=formatShort(getElapsedMs()); }

      /* Drag/Touch/Tap 狀態 */
      let activeDraggedDesktopElement = null;
      let currentTouchDraggedElement = null, touchVisualClone = null, currentTouchOffsetX = 0, currentTouchOffsetY = 0;
      let selectedTile = null;

      const currentRoundSpan = document.getElementById("current-round");
      const scoreSpan = document.getElementById("score");
      const questionsContainer = document.getElementById("questions-container");
      const quantifiersPool = document.getElementById("quantifiers-pool");
      const gameContainer = document.getElementById("game-container");
      const titleScreen = document.getElementById("title-screen");
      const titleStartGameBtn = document.getElementById("title-start-game-btn");
      const miniToast = document.getElementById("mini-toast");
      const toastText = document.getElementById("toast-text");
      const toastOk = document.getElementById("toast-ok");
      const nextFab = document.getElementById("next-round-fab");

      /* 音效 */
      const correctSynth = new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:0.005,decay:0.1,sustain:0.1,release:0.1}}).toDestination();
      const incorrectSynth = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.01,decay:0.2,sustain:0.05,release:0.1}}).toDestination();
      const gameStartSynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.05,decay:0.3,sustain:0.2,release:0.5}}).toDestination();
      const celebrateSynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.2,sustain:0.2,release:0.6}}).toDestination();
      function playCelebration(){
        try{
          correctSynth.triggerAttackRelease(["C5","E5","G5","C6"],"8n");
          ["E5","G5","C6","E6"].forEach((n,i)=> setTimeout(()=> celebrateSynth.triggerAttackRelease(n,"8n"), 150 + i*170));
        }catch(e){}
      }

      /* 工具 */
      function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
      function showToast(message, onConfirm){
        toastText.innerHTML = message;
        miniToast.classList.add('show');
        const handler = ()=>{ miniToast.classList.remove('show'); toastOk.removeEventListener('click', handler); if(onConfirm) onConfirm(); };
        toastOk.addEventListener('click', handler);
      }
      function showNextFab(isFinal=false){
        nextFab.textContent = isFinal ? "回首頁" : "下一回合";
        nextFab.style.display = "inline-block";
        nextFab.onclick = () => {
          nextFab.style.display = "none";
          if(isFinal){
            gameContainer.style.opacity='0'; gameContainer.style.pointerEvents='none';
            setTimeout(()=>{ titleScreen.style.opacity='1'; titleScreen.style.pointerEvents='auto'; initialize(); }, 300);
          }else{
            loadRound();
          }
        };
      }
      function deselectTile(){
        if(selectedTile){ selectedTile.classList.remove('selected'); selectedTile=null; document.querySelectorAll('.drop-target').forEach(t=>t.classList.remove('ready')); }
      }
      function selectTile(tile){
        if(selectedTile===tile){ deselectTile(); return; }
        if(selectedTile){ deselectTile(); }
        selectedTile = tile; tile.classList.add('selected');
        document.querySelectorAll('.drop-target').forEach(t=>t.classList.add('ready'));
      }
      function getDropTargetAtPoint(x,y){
        let candidate=null;
        // 先看題目整卡，再看原本小框
        document.querySelectorAll('.q-card, .drop-target').forEach(node=>{
          const r = node.getBoundingClientRect();
          if(x>r.left && x<r.right && y>r.top && y<r.bottom){
            if(node.classList.contains('q-card')){
              const dt=node.querySelector('.drop-target');
              if(dt) candidate=dt;
            }else{
              candidate=node;
            }
          }
        });
        return candidate;
      }

      /* 核心：放入量詞（已修：若沒成功填入會還原按鈕） */
      function handleQuantifierDrop(dropTarget, droppedQuantifier, originEl=null){
        if(!dropTarget){
          if(originEl){ originEl.classList.remove('hide-original'); }
          return;
        }

        // 若此框已經填過：還原來源並給回饋
        if(dropTarget.textContent && dropTarget.textContent.trim().length>0){
          if(originEl){ 
            originEl.classList.remove('hide-original');
            originEl.classList.add('shake');
            originEl.addEventListener('animationend',()=>originEl.classList.remove('shake'),{once:true});
          }
          dropTarget.classList.add('shake');
          dropTarget.addEventListener('animationend',()=>dropTarget.classList.remove('shake'),{once:true});
          return;
        }

        const correct = dropTarget.dataset.correctQuantifier;
        if(droppedQuantifier===correct){
          dropTarget.textContent = droppedQuantifier;
          dropTarget.style.borderStyle="solid";
          dropTarget.style.borderColor="#16a34a";
          dropTarget.style.background="#bbf7d0";
          dropTarget.style.color="#065f46";

          if(originEl){ originEl.remove(); }
          else{
            const toRemove = document.querySelector(`.quantifier-tile[data-quantifier="${droppedQuantifier}"]`);
            if(toRemove) toRemove.remove();
          }
          deselectTile();

          score += 10; scoreSpan.textContent = score;

          correctSynth.triggerAttackRelease(["C5","E5","G5"],"8n");

          answeredThisRound++;
          if(answeredThisRound===4){
            if(currentRound===12){
              stopTimer(); playCelebration();
              const elapsed = getElapsedMs();
              showToast(`🎉 恭喜你全部過關！<br>你在 <b>${formatLong(elapsed)}</b> 內全部過關了！`, () => showNextFab(true));
            }else{
              showToast("過關！太棒了！", () => showNextFab(false));
            }
          }
        }else{
          // 錯誤：還原來源並抖動
          if(originEl){
            originEl.classList.remove('hide-original');
            originEl.classList.add('shake');
            originEl.addEventListener('animationend',()=>originEl.classList.remove('shake'),{once:true});
          }
          dropTarget.classList.add('shake');
          dropTarget.addEventListener('animationend',()=>dropTarget.classList.remove('shake'),{once:true});
          incorrectSynth.triggerAttackRelease("C3","16n");
        }
      }

      /* 桌機拖曳 */
      function handleDragStart(e){ activeDraggedDesktopElement = e.target; e.dataTransfer.setData('text/plain', e.target.dataset.quantifier); e.dataTransfer.effectAllowed="move"; }
      function handleDragEnd(){ activeDraggedDesktopElement=null; }
      function handleDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect="move"; }

      /* 手機拖曳 */
      function handleTouchStart(e){
        e.preventDefault();
        const touch = e.touches[0];
        currentTouchDraggedElement = e.target;
        currentTouchDraggedElement.classList.add('hide-original');

        touchVisualClone = document.createElement('div');
        touchVisualClone.textContent = currentTouchDraggedElement.textContent;
        touchVisualClone.className = 'quantifier-tile';
        touchVisualClone.style.position='fixed';
        touchVisualClone.style.zIndex='9999';
        touchVisualClone.style.pointerEvents='none';
        touchVisualClone.style.width='64px'; touchVisualClone.style.height='40px';
        touchVisualClone.style.display='flex'; touchVisualClone.style.alignItems='center'; touchVisualClone.style.justifyContent='center';
        touchVisualClone.style.background='#fcd34d'; touchVisualClone.style.border='2px solid #3b82f6';
        touchVisualClone.style.borderRadius='10px'; touchVisualClone.style.boxShadow='0 10px 20px rgba(0,0,0,.2)';
        document.body.appendChild(touchVisualClone);

        const rect = currentTouchDraggedElement.getBoundingClientRect();
        currentTouchOffsetX = touch.clientX - rect.left;
        currentTouchOffsetY = touch.clientY - rect.top;

        touchVisualClone.style.left = (touch.clientX - currentTouchOffsetX) + 'px';
        touchVisualClone.style.top  = (touch.clientY - currentTouchOffsetY) + 'px';
      }
      function handleTouchMove(e){
        e.preventDefault();
        if(!touchVisualClone) return;
        const t = e.touches[0];
        touchVisualClone.style.left = (t.clientX - currentTouchOffsetX) + 'px';
        touchVisualClone.style.top  = (t.clientY - currentTouchOffsetY) + 'px';

        // 清除既有高亮
        document.querySelectorAll('.drop-target').forEach(dt=>dt.classList.remove('drag-over'));
        // 找到「題目整卡 or 小框」對應的小框並高亮
        const dt = getDropTargetAtPoint(t.clientX, t.clientY);
        if(dt) dt.classList.add('drag-over');
      }
      function handleTouchEnd(e){
        e.preventDefault();
        if(!touchVisualClone) return;
        const t = e.changedTouches[0];

        // 清掉高亮
        document.querySelectorAll('.drop-target').forEach(dt=>dt.classList.remove('drag-over'));

        const dt = getDropTargetAtPoint(t.clientX, t.clientY);
        handleQuantifierDrop(dt, currentTouchDraggedElement.dataset.quantifier, currentTouchDraggedElement);

        if(touchVisualClone && touchVisualClone.parentNode) touchVisualClone.parentNode.removeChild(touchVisualClone);
        touchVisualClone=null; currentTouchDraggedElement=null;
      }

      function addTapHandlers(){
        // 右欄：點一下選擇
        document.querySelectorAll('.quantifier-tile').forEach(tile=>{
          tile.addEventListener('click', ()=> selectTile(tile));
        });
        // 左欄：點一下「題目整卡」即可投放
        document.querySelectorAll('.q-card').forEach(card=>{
          const dt = card.querySelector('.drop-target');
          card.addEventListener('click', ()=> { if(!selectedTile) return; handleQuantifierDrop(dt, selectedTile.dataset.quantifier, selectedTile); });
        });
      }

      function initialize(){
        currentRound=0; score=0; answeredThisRound=0;
        stopTimer(); startTime=null; timerSpan.textContent="00:00";
        currentRoundSpan.textContent=currentRound; scoreSpan.textContent=score;
        questionsContainer.innerHTML=""; quantifiersPool.innerHTML="";
        nextFab.style.display="none";
        deselectTile();
      }

      async function startGame(){
        try{ await Tone.start(); }catch(e){}
        titleScreen.style.opacity='0'; titleScreen.style.pointerEvents='none';
        setTimeout(()=>{ gameContainer.style.opacity='1'; gameContainer.style.pointerEvents='auto'; }, 300);
        try{ gameStartSynth.triggerAttackRelease("C5","8n"); }catch(e){}
        initialize(); startTimer(); loadRound();
      }

      function loadRound(){
        currentRound++; currentRoundSpan.textContent=currentRound;
        answeredThisRound=0; questionsContainer.innerHTML=""; quantifiersPool.innerHTML=""; nextFab.style.display="none"; deselectTile();

        if(currentRound>gameData.length){
          stopTimer(); playCelebration();
          const elapsed = getElapsedMs();
          showToast(`🎉 恭喜你全部過關！<br>你在 <b>${formatLong(elapsed)}</b> 內全部過關了！`, ()=> showNextFab(true));
          return;
        }

        const currentQuestions = [...gameData[currentRound-1]];

        // 左欄 4 題（整卡可當成大型投放區）
        currentQuestions.forEach((q)=>{
          const card = document.createElement('div');
          card.className = 'q-card';
          card.innerHTML = `
            <div class="q-emoji">${q.emoji}</div>
            <div class="q-line">
              <span>${q.prefix}</span>
              <span class="drop-target" data-correct-quantifier="${q.quantifier}"></span>
              <span>${q.noun}</span>
            </div>
          `;
          questionsContainer.appendChild(card);

          const dt = card.querySelector('.drop-target');

          // 原本小框的 DnD
          dt.addEventListener('dragover', e=>{ e.preventDefault(); dt.classList.add('drag-over'); });
          dt.addEventListener('dragleave', e=>{ dt.classList.remove('drag-over'); });
          dt.addEventListener('drop', e=>{
            e.preventDefault(); dt.classList.remove('drag-over');
            const qv = e.dataTransfer.getData('text/plain');
            handleQuantifierDrop(dt, qv, activeDraggedDesktopElement);
          });

          // 整卡也可接：把視覺回饋代理到 dt
          card.addEventListener('dragover', e=>{ e.preventDefault(); dt.classList.add('drag-over'); });
          card.addEventListener('dragleave', e=>{ dt.classList.remove('drag-over'); });
          card.addEventListener('drop', e=>{
            e.preventDefault(); dt.classList.remove('drag-over');
            const qv = e.dataTransfer.getData('text/plain');
            handleQuantifierDrop(dt, qv, activeDraggedDesktopElement);
          });
        });

        // 右欄：4 正確 + 1 干擾
        const correctQ = currentQuestions.map(q=>q.quantifier);
        const allQ = gameData.flat().map(q=>q.quantifier);
        let distracter=null; while(true){ const r=allQ[Math.floor(Math.random()*allQ.length)]; if(!correctQ.includes(r)){ distracter=r; break; } }
        const options = shuffleArray([...correctQ, distracter]);

        options.forEach(qf=>{
          const tile = document.createElement('div');
          tile.className = 'quantifier-tile';
          tile.textContent = qf;
          tile.setAttribute('draggable','true');
          tile.dataset.quantifier = qf;
          quantifiersPool.appendChild(tile);

          // 桌機拖曳
          tile.addEventListener('dragstart', handleDragStart);
          tile.addEventListener('dragend', handleDragEnd);
          // 手機拖曳
          tile.addEventListener('touchstart', handleTouchStart, {passive:false});
          tile.addEventListener('touchmove',  handleTouchMove,  {passive:false});
          tile.addEventListener('touchend',   handleTouchEnd,   {passive:false});
        });

        // 點按備援
        addTapHandlers();
      }

      document.addEventListener('dragover', handleDragOver); // 允許全域 dragover 阻止預設
      document.addEventListener('drop', e=>e.preventDefault()); // 避免把文字丟到頁面造成跳轉

      document.getElementById('title-start-game-btn').addEventListener('click', startGame);
      initialize();
    };
  </script>
</body>
</html>





